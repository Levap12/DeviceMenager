#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ Device Manager Ð² Docker

set -e

echo "ðŸ³ Device Manager - Ð‘Ñ‹ÑÑ‚Ñ€Ð¾Ðµ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ"
echo "=========================================="
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½!"
    echo "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Docker: https://docs.docker.com/get-docker/"
    exit 1
fi

if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
    echo "âŒ Docker Compose Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½!"
    echo "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Docker Compose: https://docs.docker.com/compose/install/"
    exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° config.env
if [ ! -f "config.env" ]; then
    echo "âš ï¸  Ð¤Ð°Ð¹Ð» config.env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
    echo "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ config.env..."
    
    read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Telegram Bot Token: " BOT_TOKEN
    read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ URL ÑÐ°Ð¹Ñ‚Ð° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: https://your-domain.com): " WEB_URL
    
    cat > config.env << EOF
# Telegram Bot Token
TELEGRAM_BOT_TOKEN=${BOT_TOKEN}

# URLs
WEB_URL=${WEB_URL}
API_URL=${WEB_URL}
EOF
    
    echo "âœ… Ð¤Ð°Ð¹Ð» config.env ÑÐ¾Ð·Ð´Ð°Ð½!"
    echo ""
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…
mkdir -p data
chmod 755 data

echo "ðŸ”¨ Ð¡Ð±Ð¾Ñ€ÐºÐ° Docker Ð¾Ð±Ñ€Ð°Ð·Ð°..."
docker-compose build

echo ""
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
docker-compose up -d

echo ""
echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°..."
sleep 5

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
if docker-compose ps | grep -q "Up"; then
    echo ""
    echo "âœ… Device Manager ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"
    echo ""
    echo "ðŸ“Š Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ:"
    echo "   ðŸŒ Ð’ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ: http://localhost:8000"
    echo "   ðŸ“¡ API Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ: http://localhost:8000/docs"
    echo "   ðŸ“± Telegram webhook: http://localhost:8000/telegram/webhook"
    echo ""
    echo "ðŸ“ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
    echo "   docker-compose logs -f         # ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð²"
    echo "   docker-compose ps              # Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²"
    echo "   docker-compose restart         # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº"
    echo "   docker-compose down            # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°"
    echo ""
else
    echo ""
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ°!"
    echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸: docker-compose logs"
    exit 1
fi

